<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1080, height:1920, initial-scale=1" />
  <title>Live Game Display</title>
  <style>
    html,body {
      height:100%;
      margin:0;
      font-family:Inter,Arial,sans-serif;
      background:#000;
      color:#fff;
      overflow:hidden;
    }
    
    .main-container {
      display:flex; 
      flex-direction:column; 
      height:100%;
      width:1080px; 
      margin: 0 auto;
      box-sizing: border-box;
    }
    
    .wrap {
      display:flex; 
      flex-direction: column;
      flex: 1; 
      padding:24px;
      box-sizing: border-box;
    }

    .teams-row {
        display: flex;
        gap: 24px;
    }

    .game-info-bar {
      display:flex;
      justify-content:space-between;
      padding:16px 48px; 
      align-items:center;
      background:rgba(0,0,0,0.45);
      font-size:var(--metaFontSize);
      width: 100%;
      box-sizing: border-box;
      margin: 16px 0;
      border-radius: 8px;
    }

    .team-column {
      flex: 1; 
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.6); 
      border-radius: 12px;
      overflow: hidden; 
    }

    .top {
      display:flex;
      align-items:center;
      justify-content:center; 
      padding:var(--topPadding);
      height:var(--topHeight);
      flex-direction: column; 
      box-sizing: border-box;
    }
    
    .game-time {
      display: none;
    }
    .logo {
      width:var(--logoSize);
      height:var(--logoSize);
      object-fit:contain;
      background:rgba(255,255,255,0.05);
      border-radius:12px;
    }
    .score {
      font-size:var(--scoreFontSize);
      font-weight:900;
      margin-top:8px;
      line-height:1;
    }
    .name {
      font-size:var(--nameFontSize);
      font-weight:700;
      margin-top:4px;
      text-align:center;
    }

    .body {
      display:flex;
      flex:1;
      gap:8px; 
      padding:16px; 
      box-sizing:border-box;
      flex-direction:column; 
      background:rgba(0,0,0,0.4); 
    }
    
    .stats-container { 
      flex-grow: 0; 
      padding: 8px 16px; 
      overflow: auto;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
    .stat-row {
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    .leaders-container {
      flex: 0 0 var(--leadersHeight); 
      padding: 16px;
      overflow: auto;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
    .leader {
      position:relative;
      display:flex;
      gap:12px;
      align-items:center;
      padding:8px 0;
    }
    .headshot {
      width:72px;
      height:72px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid rgba(255,255,255,0.2);
    }
    .team-icon {
      position:absolute;
      bottom:-4px;
      right:-4px;
      width:32px;
      height:32px;
      border-radius:50%;
      border:2px solid #fff;
      background:#000;
      object-fit:cover;
    }
    h2 {
      margin-top:0;
      font-size:30px;
    }
    h3 {
        font-size: 24px;
        margin-top: 0;
        margin-bottom: 8px;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding-bottom: 4px;
    }
    .small {
      font-size:20px;
      color:rgba(255,255,255,0.8);
    }
    .away-column .top { background-color: var(--awayColor); }
    .home-column .top { background-color: var(--homeColor); }
  </style>
</head>
<body>
  
  <div class="main-container">
    
    <div class="wrap">
        
      <!-- Team Headers Row -->
      <div class="teams-row">
          
        <div class="team-column away-column">
          <div class="top" id="awayTeamTop">
            <div class="game-time" id="awayClock"></div>
            <img class="logo" id="awayLogo" />
            <div class="score" id="awayScore">0</div>
            <div class="name" id="awayName">Away</div>
          </div>
        </div>
        
        <div class="team-column home-column">
          <div class="top" id="homeTeamTop">
            <div class="game-time" id="homeClock"></div>
            <img class="logo" id="homeLogo" />
            <div class="score" id="homeScore">0</div>
            <div class="name" id="homeName">Home</div>
          </div>
        </div>
        
      </div>

      <!-- Game Info Bar spans full width -->
      <div class="game-info-bar">
        <div id="venue">Venue Name</div>
        <div id="clock">0:00</div>
        <div id="period">1st Half</div>
      </div>

      <!-- Stats and Leaders Row -->
      <div class="teams-row" style="flex: 1;">
          
        <div class="team-column away-column">
          <div class="body">
            <div class="stats-container">
              <h2>Team Stats</h2>
              <div id="awayStats"></div>
            </div>
            <div class="leaders-container">
              <h2>Leaders</h2>
              <div id="awayLeaders"></div>
            </div>
          </div>
        </div>
        
        <div class="team-column home-column">
          <div class="body">
            <div class="stats-container">
              <h2>Team Stats</h2>
              <div id="homeStats"></div>
            </div>
            <div class="leaders-container">
              <h2>Leaders</h2>
              <div id="homeLeaders"></div>
            </div>
          </div>
        </div>
        
      </div>

    </div>
  </div>

<script>
(async function(){
  const root = document.documentElement;
  root.style.setProperty("--topHeight", "420px");
  root.style.setProperty("--logoSize", "220px");
  root.style.setProperty("--scoreFontSize", "110px");
  root.style.setProperty("--nameFontSize", "36px");
  root.style.setProperty("--metaFontSize", "28px");
  root.style.setProperty("--leadersHeight", "350px");
  root.style.setProperty("--timeFontSize", "24px");
  root.style.setProperty("--topGap", "24px");
  root.style.setProperty("--topPadding", "24px");
  root.style.setProperty("--teamPadding", "20px");
  
  root.style.setProperty("--homeColor", "#333333");
  root.style.setProperty("--awayColor", "#333333");

  const qs = new URLSearchParams(location.search);
  let gameId = qs.get("gameId");

  if (!gameId) {
    const res = await fetch("/api/track");
    const js = await res.json();
    gameId = js.gameId;
  }

  if (!gameId) {
    document.body.innerHTML = "<h1 style='text-align:center;margin-top:200px'>No game selected</h1>";
    return;
  }
  
  function toTitleCase(str) {
      return str
          .replace(/([A-Z])/g, ' $1') // Add space before capital letters
          .replace(/[_-]/g, ' ') // Replace underscores and hyphens with spaces
          .trim()
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
  }
  
  function renderStats(containerId, teamStats) {
      const statsEl = document.getElementById(containerId);
      statsEl.innerHTML = "";
      
      (teamStats.stats || [])
          .filter(s => !/^avg/i.test(s.displayName || s.name || ""))
          .forEach(s => {
              const row = document.createElement("div");
              row.className = "stat-row";
              const label = s.displayName || s.name || "";
              const formattedLabel = toTitleCase(label);
              row.innerHTML = `<span>${formattedLabel}</span><span>${s.displayValue || s.value || ""}</span>`;
              statsEl.appendChild(row);
          });
  }
  
  function renderLeaders(containerId, teamObj) {
      const leadersEl = document.getElementById(containerId);
      leadersEl.innerHTML = "";
      const tLogo = teamObj.team?.logo || "";
      
      (teamObj.leaders || []).forEach(group => {
          const leader = group.leaders?.[0];
          if (!leader) return;
          const div = document.createElement("div");
          div.className = "leader";
          div.innerHTML = `
              <div style="position:relative">
                <img class="headshot" src="${leader.athlete?.headshot || ""}" onerror="this.style.display='none'">
                ${tLogo ? `<img class="team-icon" src="${tLogo}" alt="">` : ""}
              </div>
              <div>
                <div><strong>${leader.athlete?.displayName || teamObj.team?.shortDisplayName}</strong></div>
                <div class="small">${group.displayName || ""}: ${leader.displayValue || ""}</div>
              </div>
            `;
          leadersEl.appendChild(div);
      });
  }


  async function fetchAndRender() {
    try {
      const res = await fetch(`/api/ncaagamesm/${gameId}`);
      const data = await res.json();

      const comp = data.competitions?.[0];
      if (!comp) return;

      const competitors = comp.competitors || [];
      const home = competitors.find(t => t.homeAway === "home") || {};
      const away = competitors.find(t => t.homeAway === "away") || {};

      const homeTeam = home.team || {};
      const awayTeam = away.team || {};

      const homeColor = "#" + (homeTeam.color || "333333");
      const awayColor = "#" + (awayTeam.color || "333333");
      
      root.style.setProperty("--homeColor", homeColor);
      root.style.setProperty("--awayColor", awayColor);

      document.getElementById("homeLogo").src = homeTeam.logo || "";
      document.getElementById("awayLogo").src = awayTeam.logo || "";
      document.getElementById("homeName").textContent = homeTeam.shortDisplayName || homeTeam.displayName || "Home";
      document.getElementById("awayName").textContent = awayTeam.shortDisplayName || awayTeam.displayName || "Away";
      document.getElementById("homeScore").textContent = home.score ?? "0";
      document.getElementById("awayScore").textContent = away.score ?? "0";

      const clockTxt = comp.status?.displayClock || "";
      const periodTxt = comp.status?.type?.shortDetail || "";
      
      document.getElementById("venue").textContent = comp.venue?.fullName || "";
      document.getElementById("clock").textContent = clockTxt;
      document.getElementById("period").textContent = periodTxt;

      renderStats("awayStats", { stats: away.statistics || [] });
      renderStats("homeStats", { stats: home.statistics || [] });
      
      renderLeaders("awayLeaders", away);
      renderLeaders("homeLeaders", home);
      
    } catch (err) {
      console.error("Fetch/render error:", err);
    }
  }

  fetchAndRender();
  setInterval(fetchAndRender, 15000);
})();
</script>
</body>
</html>